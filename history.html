<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial por Sucursal — DJ’ Cantina 20</title>

  <!-- Fuente y estilos base que ya usas -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />

  <style>
    body { font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .toolbar { display:flex; gap:10px; margin-bottom:12px; align-items:center; flex-wrap: wrap; }
    .grid { display:grid; gap:14px; }
    /* En móviles 2 columnas, tablets 3, desktop 4-6 */
    .grid { grid-template-columns: repeat(2, minmax(220px,1fr)); }
    @media (min-width: 900px){ .grid{ grid-template-columns: repeat(4, minmax(240px,1fr)); } }
    @media (min-width: 1200px){ .grid{ grid-template-columns: repeat(6, minmax(240px,1fr)); } }

    .col {
      background:#15161d; border:1px solid #2b2c36; border-radius:12px; padding:12px;
      min-height: 220px;
    }
    .col h3 { margin:0 0 8px 0; font-size:16px; display:flex; justify-content:space-between; align-items:center; }
    .count { font-size:12px; color:#b8bac7 }
    .item { border-top:1px solid #23242e; padding:8px 0; font-size:13px }
    .item:first-of-type{ border-top:none; }
    .muted { color:#b8bac7 }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; margin-left:6px }
    .pending{ background:#3a2d12; color:#ffd89b; border:1px solid #5a4723 }
    .played{ background:#16341f; color:#a9f0bf; border:1px solid #235d38 }
    .rejected{ background:#4a1f25; color:#ffc7ce; border:1px solid #7a303d }
    .id { color:#8ea0ff; font-size:11px; word-break: break-all; }
    .topbox { margin: 12px 0 0; font-size:13px }
    .topbox ol { margin:6px 0 0 18px; }
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <img id="logo" alt="Logo">
      <div>
        <h1 data-brand-name>DJ’ Cantina 20</h1>
        <p class="muted">Historial por sucursal (vista rápida en columnas)</p>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <label>Estado:
          <select id="statusFilter">
            <option value="all">Todos</option>
            <option value="pending">Pendientes</option>
            <option value="played">Reproducidas</option>
            <option value="rejected">Rechazadas</option>
          </select>
        </label>
        <label>Desde: <input type="date" id="fromDate" /></label>
        <label>Hasta: <input type="date" id="toDate" /></label>
        <button class="btn" id="clearBtn">Limpiar filtros</button>
      </div>

      <!-- Contenedor de columnas -->
      <div id="cols" class="grid"></div>

      <!-- Top global (según filtros) -->
      <div id="topGlobal" class="topbox"></div>
    </section>
  </main>

  <!-- Branding y Firebase -->
  <script type="module" src="branding.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, orderBy, query
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJGgPddVWwKytKv8GlPvZ27vkqZfod-4U",
      authDomain: "dj-cantina-20.firebaseapp.com",
      projectId: "dj-cantina-20",
      storageBucket: "dj-cantina-20.firebasestorage.app",
      messagingSenderId: "777157429108",
      appId: "1:777157429108:web:de2efae209dcca67228e21"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Sucursales definidas (IDs tal como guardas en unitId)
    const UNITS = [
      "polanco","reforma","antara","santa-fe","satelite","metepec",
      "artz","monterrey","guadalajara","cancun","merida","wtc"
    ];

    // DOM
    const colsEl = document.getElementById("cols");
    const statusFilter = document.getElementById("statusFilter");
    const fromDate = document.getElementById("fromDate");
    const toDate   = document.getElementById("toDate");
    const clearBtn = document.getElementById("clearBtn");
    const topGlobal = document.getElementById("topGlobal");

    let all = []; // todas las solicitudes

    // Suscripción en tiempo real
    const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snap) => {
      all = [];
      snap.forEach(doc => {
        const d = doc.data();
        all.push({
          ts: toMillis(d.timestamp),
          song: (d.song||"").trim(),
          artist: (d.artist||"").trim(),
          id: (d.spotifyId||"").trim(),
          status: d.status || "pending",
          unit: d.unitId ? String(d.unitId).toLowerCase() : "(sin)"
        });
      });
      render();
    });

    function toMillis(ts){ if(!ts) return null; if(typeof ts==="number") return ts; if(typeof ts.toMillis==="function") return ts.toMillis(); if(ts instanceof Date) return ts.getTime(); return null; }
    function esc(s){ return String(s??"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function nice(unit){ if(unit==="(sin)") return "(sin sucursal)"; return unit.replace(/-/g," ").replace(/\b\w/g,m=>m.toUpperCase()); }

    function getFiltered(){
      const s = statusFilter.value;
      const fromTs = fromDate.value ? new Date(fromDate.value).getTime() : null;
      const toTs   = toDate.value   ? new Date(toDate.value).getTime() + 24*60*60*1000 - 1 : null;

      return all.filter(r=>{
        if (s !== "all" && r.status !== s) return false;
        if (fromTs && (r.ts ?? 0) < fromTs) return false;
        if (toTs && (r.ts ?? 0) > toTs) return false;
        return true;
      });
    }

    function groupByUnit(rows){
      const map = new Map();
      // Inicializa todas las unidades (para que siempre salgan columnas)
      UNITS.forEach(u => map.set(u, []));
      map.set("(sin)", []); // columna extra para legacy

      rows.forEach(r=>{
        const u = map.has(r.unit) ? r.unit : (r.unit || "(sin)");
        map.get(u).push(r);
      });
      return map;
    }

    function topCounts(rows, limit=10){
      const m = new Map();
      rows.forEach(r=>{
        const key = (r.id || `${r.song}|||${r.artist}` || r.song).toLowerCase();
        if (!key) return;
        const prev = m.get(key) || { name: `${r.song} — ${r.artist||"Artista desconocido"}`, count:0 };
        prev.count += 1; m.set(key, prev);
      });
      return Array.from(m.values()).sort((a,b)=>b.count-a.count).slice(0,limit);
    }

    function render(){
      const rows = getFiltered();
      const byUnit = groupByUnit(rows);

      colsEl.innerHTML = "";

      // Render por unidad (columna)
      Array.from(byUnit.entries()).forEach(([unit, list])=>{
        const col = document.createElement("div");
        col.className = "col";

        // Header columna
        const h3 = document.createElement("h3");
        const title = document.createElement("span");
        title.textContent = nice(unit);
        const count = document.createElement("span");
        count.className = "count";
        count.textContent = `${list.length} req`;
        h3.appendChild(title); h3.appendChild(count);
        col.appendChild(h3);

        if (list.length === 0){
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "Sin solicitudes";
          col.appendChild(p);
        } else {
          // Render items (máx 50 por columna para no hacerla infinita)
          list.slice(0,50).forEach(r=>{
            const d = document.createElement("div");
            d.className = "item";
            const dt = r.ts ? new Date(r.ts).toLocaleString() : "-";
            d.innerHTML = `
              <div>${esc(r.song)} — ${esc(r.artist || "Artista desconocido")}</div>
              ${r.id ? `<div class="id">${esc(r.id)}</div>` : ``}
              <div class="muted">${dt} <span class="pill ${r.status}">${esc(r.status)}</span></div>
            `;
            col.appendChild(d);
          });
        }

        colsEl.appendChild(col);
      });

      // Top global
      const top = topCounts(rows, 10);
      topGlobal.innerHTML =
        "<h3>Top 10 global (según filtros)</h3>" +
        (top.length ? "<ol>" + top.map(t=>`<li>${esc(t.name)} — ${t.count}</li>`).join("") + "</ol>"
                    : "<p class='muted'>Sin datos</p>");
    }

    // Eventos filtros
    [statusFilter, fromDate, toDate].forEach(el => el.addEventListener("change", render));
    clearBtn.addEventListener("click", ()=>{ statusFilter.value="all"; fromDate.value=""; toDate.value=""; render(); });
  </script>
</body>
</html>
