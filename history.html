<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Solicitudes â€” DJâ€™ Cantina 20</title>

  <!-- Fuente y estilos base -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#111114">
  <link rel="stylesheet" href="style.css" />

  <!-- Parche de UX: scroll, sticky toolbar, thead fijo -->
  <style>
    body { font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    /* Anula el centrado vertical global para permitir scroll natural */
    body{ align-items:flex-start; justify-content:flex-start; }

    /* Contenedor mÃ¡s ancho para ver mÃ¡s columnas */
    .container{ max-width: 1200px; }

    /* Barra de filtros pegada arriba y clickeable */
    .toolbar{
      position: sticky; top: 0; z-index: 10;
      background: var(--card); padding: 8px; border-radius: 10px; border:1px solid #2a2b35;
      margin-bottom: 12px; display:flex; gap:10px; align-items:center; flex-wrap: wrap;
    }

    /* Contenedor scrolleable solo para la tabla */
    .table-scroller{
      max-height: 70vh; overflow: auto; border-radius: 12px; border:1px solid #2a2b35;
      background: var(--card);
    }

    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #2a2b35; padding: 8px; font-size:14px }
    thead th{
      position: sticky; top: 0; z-index: 2;
      background:#1b1c23; color:#e8e8ee; text-align:left;
    }

    .pill{ padding:2px 8px; border-radius:999px; font-size:12px; display:inline-block }
    .pending{ background:#3a2d12; color:#ffd89b; border:1px solid #5a4723 }
    .played{ background:#16341f; color:#a9f0bf; border:1px solid #235d38 }
    .rejected{ background:#4a1f25; color:#ffc7ce; border:1px solid #7a303d }
    .badge{ margin-left:8px; font-weight:700; padding:2px 8px; border-radius:999px;
            background:#20222b; border:1px solid #343648; display:inline-block }
    #topSongs ol{ margin:6px 0 0 20px }
    .muted{ color:#b3b3b9 }
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <img id="logo" alt="logovideos.png">
      <div>
        <h1 data-brand-name>DJâ€™ Cantina 20</h1>
        <p class="muted">Sucursal filtrada: <strong id="unitTag"></strong></p>
      </div>
    </header>

    <section class="card">
      <!-- Toolbar sticky -->
      <div class="toolbar">
        <label>Estado:
          <select id="statusFilter">
            <option value="all">Todos</option>
            <option value="pending">Pendientes</option>
            <option value="played">Reproducidas</option>
            <option value="rejected">Rechazadas</option>
          </select>
        </label>
        <label>Desde: <input type="date" id="fromDate" /></label>
        <label>Hasta: <input type="date" id="toDate" /></label>

        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="groupToggle" checked>
          Agrupar duplicadas (ðŸ”¥)
        </label>

        <button class="btn secondary" id="clearFilters" type="button">Limpiar filtros</button>
        <button class="btn" id="exportCsv" type="button">Exportar CSV</button>
      </div>

      <div id="topSongs"><h3>Top 10 mÃ¡s pedidas</h3><p class="muted">Cargandoâ€¦</p></div>

      <!-- Tabla con scroll propio y thead fijo -->
      <div class="table-scroller">
        <table>
          <thead>
            <tr id="theadRow">
              <th>Fecha/Hora</th>
              <th>CanciÃ³n</th>
              <th>Artista</th>
              <th>Spotify ID</th>
              <th>Estado</th>
              <th>Sucursal</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    // === Config ===
    const unitParam = new URLSearchParams(location.search).get('unit');
    const UNIT = unitParam ? unitParam.toLowerCase() : null;
    document.getElementById('unitTag').textContent = UNIT || "(falta ?unit=...)";

    // Si no hay ?unit=, avisamos y paramos
    if (!UNIT) {
      document.getElementById('historyBody').innerHTML =
        `<tr><td colspan="6" class="muted">Agrega ?unit=merida (por ejemplo) a la URL.</td></tr>`;
      throw new Error("unit query param required");
    }

    // === Firebase ===
    const [{ initializeApp }, firestore] = await Promise.all([
      import("https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"),
      import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"),
    ]);
    const { getFirestore, collection, onSnapshot, orderBy, query, where } = firestore;

    const firebaseConfig = {
      apiKey: "AIzaSyAJGgPddVWwKytKv8GlPvZ27vkqZfod-4U",
      authDomain: "dj-cantina-20.firebaseapp.com",
      projectId: "dj-cantina-20",
      storageBucket: "dj-cantina-20.firebasestorage.app",
      messagingSenderId: "777157429108",
      appId: "1:777157429108:web:de2efae209dcca67228e21"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // === DOM ===
    const statusFilter = document.getElementById("statusFilter");
    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");
    const clearBtn = document.getElementById("clearFilters");
    const exportBtn = document.getElementById("exportCsv");
    const groupToggle = document.getElementById("groupToggle");
    const tbody = document.getElementById("historyBody");
    const topBox = document.getElementById("topSongs");
    const theadRow = document.getElementById("theadRow");

    let all = [];

    // === SuscripciÃ³n solo a la unidad solicitada ===
    const q = query(
      collection(db, "requests"),
      where("unitId", "==", UNIT),
      orderBy("timestamp", "desc")
    );
    onSnapshot(q, (snap) => {
      all = [];
      snap.forEach(doc => {
        const d = doc.data();
        all.push({
          ts: toMillis(d.timestamp),
          song: (d.song||"").trim(),
          artist: (d.artist||"").trim(),
          id: (d.spotifyId||"").trim(),
          status: d.status || "pending",
          unit: d.unitId || UNIT
        });
      });
      render();
    }, err => {
      console.error(err);
      // Fallback sin orderBy (por si Ã­ndices)
      const q2 = query(collection(db, "requests"), where("unitId","==", UNIT));
      onSnapshot(q2, (snap2)=>{
        all = [];
        snap2.forEach(doc => {
          const d = doc.data();
          all.push({
            ts: toMillis(d.timestamp),
            song: (d.song||"").trim(),
            artist: (d.artist||"").trim(),
            id: (d.spotifyId||"").trim(),
            status: d.status || "pending",
            unit: d.unitId || UNIT
          });
        });
        render();
      });
    });

    function toMillis(ts){
      if(!ts) return null;
      if(typeof ts==="number") return ts;
      if(typeof ts.toMillis==="function") return ts.toMillis();
      if(ts instanceof Date) return ts.getTime();
      return null;
    }
    function esc(s){ return String(s??"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    function getFiltered(){
      const sVal = statusFilter.value;
      const fromTs = fromDate.value ? new Date(fromDate.value).getTime() : null;
      const toTs   = toDate.value   ? new Date(toDate.value).getTime() + 24*60*60*1000 - 1 : null;
      return all.filter(r=>{
        if (sVal !== "all" && r.status !== sVal) return false;
        if (fromTs && (r.ts ?? 0) < fromTs) return false;
        if (toTs && (r.ts ?? 0) > toTs) return false;
        return true;
      });
    }

    // AgrupaciÃ³n por spotifyId; si no hay, por "canciÃ³n|||artista"
    function groupRows(rows){
      const groups = new Map();
      rows.forEach(r=>{
        const keyBase = r.id || (r.song && r.artist ? `${r.song}|||${r.artist}` : r.song) || "";
        const key = keyBase.toLowerCase();
        if (!key) return;
        if (!groups.has(key)){
          groups.set(key, {
            song: r.song, artist: r.artist, id: r.id,
            count: 0, lastTs: 0, byStatus: { pending:0, played:0, rejected:0 }
          });
        }
        const g = groups.get(key);
        g.count += 1;
        g.lastTs = Math.max(g.lastTs || 0, r.ts || 0);
        g.byStatus[r.status] = (g.byStatus[r.status] || 0) + 1;
      });
      return Array.from(groups.values()).sort((a,b)=>{
        const c = b.count - a.count; if (c!==0) return c;
        return (b.lastTs||0) - (a.lastTs||0);
      });
    }

    function render(){
      const rows = getFiltered();
      const grouped = groupToggle.checked;

      // Encabezados segÃºn modo
      theadRow.innerHTML = grouped ? `
        <th>Ãšltima vez</th>
        <th>CanciÃ³n â€” Artista</th>
        <th>Spotify ID</th>
        <th>Total / Pend-Rep-Rech</th>
        <th>Sucursal</th>
      ` : `
        <th>Fecha/Hora</th>
        <th>CanciÃ³n</th>
        <th>Artista</th>
        <th>Spotify ID</th>
        <th>Estado</th>
        <th>Sucursal</th>
      `;

      tbody.innerHTML = "";

      if (grouped){
        const gs = groupRows(rows);
        // Top 10
        topBox.innerHTML =
          "<h3>Top 10 mÃ¡s pedidas</h3>" +
          (gs.slice(0,10).length
            ? "<ol>" + gs.slice(0,10).map(g=>`<li>${esc(g.song)} â€” ${esc(g.artist||"Artista desconocido")} â€” ${g.count}</li>`).join("") + "</ol>"
            : "<p class='muted'>Sin datos</p>");

        gs.forEach(g=>{
          const tr = document.createElement("tr");
          const dt = g.lastTs ? new Date(g.lastTs).toLocaleString() : "-";
          const summary = `${g.count} / ${g.byStatus.pending||0}-${g.byStatus.played||0}-${g.byStatus.rejected||0}`;
          tr.innerHTML = `
            <td>${dt}</td>
            <td>${esc(g.song)} â€” ${esc(g.artist||"Artista desconocido")} ${g.count>1?`<span class="badge">ðŸ”¥ x${g.count}</span>`:""}</td>
            <td>${esc(g.id)}</td>
            <td>${summary}</td>
            <td>${esc(UNIT)}</td>
          `;
          tbody.appendChild(tr);
        });

      } else {
        // Detalle
        const counts = {};
        rows.forEach(r=>{
          const key = `${r.song} â€” ${r.artist||"Artista desconocido"}`;
          counts[key] = (counts[key]||0)+1;
        });
        const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        topBox.innerHTML =
          "<h3>Top 10 mÃ¡s pedidas</h3>" +
          (top.length ? "<ol>" + top.map(([s,c])=>`<li>${esc(s)} â€” ${c}</li>`).join("") + "</ol>" : "<p class='muted'>Sin datos</p>");

        rows.forEach(r=>{
          const tr = document.createElement("tr");
          const dt = r.ts ? new Date(r.ts).toLocaleString() : "-";
          tr.innerHTML = `
            <td>${dt}</td>
            <td>${esc(r.song)}</td>
            <td>${esc(r.artist||"Artista desconocido")}</td>
            <td>${esc(r.id)}</td>
            <td><span class="pill ${r.status}">${esc(r.status)}</span></td>
            <td>${esc(UNIT)}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

    // Filtros
    [statusFilter, fromDate, toDate, groupToggle].forEach(el=>el.addEventListener("change", render));
    clearBtn.addEventListener("click", ()=>{ statusFilter.value="all"; fromDate.value=""; toDate.value=""; render(); });

    // Export CSV
    exportBtn.addEventListener("click", ()=>{
      const rows = getFiltered();
      const grouped = groupToggle.checked;

      function dl(csv, name){
        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href=url; a.download=name; a.click();
        URL.revokeObjectURL(url);
      }

      if (grouped){
        const gs = groupRows(rows);
        const header = ["Ãšltima vez","CanciÃ³n","Artista","Spotify ID","Total","Pendientes","Reproducidas","Rechazadas","Sucursal"];
        const lines = gs.map(g=>{
          const dt = g.lastTs ? new Date(g.lastTs).toLocaleString() : "-";
          return [dt,g.song,g.artist||"",g.id,g.count,g.byStatus.pending||0,g.byStatus.played||0,g.byStatus.rejected||0,UNIT]
                 .map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",");
        });
        dl([header.join(","),...lines].join("\n"), `historial_grouped_${UNIT}_${new Date().toISOString().slice(0,10)}.csv`);
      } else {
        const header = ["Fecha/Hora","CanciÃ³n","Artista","Spotify ID","Estado","Sucursal"];
        const lines = rows.map(r=>{
          const dt = r.ts ? new Date(r.ts).toLocaleString() : "-";
          return [dt,r.song,r.artist||"",r.id,r.status,UNIT]
                 .map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",");
        });
        dl([header.join(","),...lines].join("\n"), `historial_detalle_${UNIT}_${new Date().toISOString().slice(0,10)}.csv`);
      }
    });
  </script>
</body>
</html>
